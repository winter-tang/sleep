<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全面铃声播放测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.stop {
            background-color: #f44336;
        }
        button.stop:hover {
            background-color: #d32f2f;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        .info {
            background-color: #d9edf7;
            color: #31708f;
        }
        .warning {
            background-color: #fcf8e3;
            color: #8a6d3b;
        }
        .log-container {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .error-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
            max-width: 80%;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>全面铃声播放测试</h1>
    
    <div class="test-section">
        <h2>1. 基础HTML5 Audio播放</h2>
        <button onclick="testBasicAudio('1.mp3')">播放1.mp3</button>
        <button onclick="testBasicAudio('2.mp3')">播放2.mp3</button>
        <button onclick="testBasicAudio('alarm.mp3')">播放alarm.mp3</button>
        <button onclick="stopBasicAudio()" class="stop">停止基础Audio</button>
        <div id="basicAudioStatus" class="status info">准备测试基础HTML5 Audio播放</div>
    </div>
    
    <div class="test-section">
        <h2>2. 临时Audio元素播放</h2>
        <button onclick="testTempAudio('1.mp3')">播放1.mp3</button>
        <button onclick="testTempAudio('2.mp3')">播放2.mp3</button>
        <button onclick="testTempAudio('alarm.mp3')">播放alarm.mp3</button>
        <button onclick="stopTempAudio()" class="stop">停止临时Audio</button>
        <div id="tempAudioStatus" class="status info">准备测试临时Audio元素播放</div>
    </div>
    
    <div class="test-section">
        <h2>3. Android原生音频播放</h2>
        <button onclick="testNativeAudio('1.mp3')">播放1.mp3</button>
        <button onclick="testNativeAudio('2.mp3')">播放2.mp3</button>
        <button onclick="testNativeAudio('alarm.mp3')">播放alarm.mp3</button>
        <button onclick="stopNativeAudio()" class="stop">停止原生Audio</button>
        <div id="nativeAudioStatus" class="status info">准备测试Android原生音频播放</div>
    </div>
    
    <div class="test-section">
        <h2>4. 闹钟播放方法</h2>
        <button onclick="testAlarmAudio('alarm.mp3')">播放闹钟</button>
        <button onclick="stopAlarmAudio()" class="stop">停止闹钟</button>
        <div id="alarmAudioStatus" class="status info">准备测试闹钟播放方法</div>
    </div>
    
    <div class="test-section">
        <h2>5. 组合播放测试</h2>
        <button onclick="testCombo1()">组合1: 1.mp3 + 2.mp3</button>
        <button onclick="testCombo2()">组合2: 闹钟 + 震动</button>
        <button onclick="testCombo3()">组合3: 1.mp3 + 2.mp3 + 闹钟</button>
        <button onclick="stopAllAudio()" class="stop">停止所有音频</button>
        <div id="comboAudioStatus" class="status info">准备测试组合播放</div>
    </div>
    
    <div class="test-section">
        <h2>6. 错误处理测试</h2>
        <button onclick="testErrorHandling()">测试错误处理</button>
        <button onclick="testErrorPopup()" class="stop">测试错误弹窗</button>
        <div id="errorHandlingStatus" class="status info">准备测试错误处理</div>
    </div>
    
    <div class="test-section">
        <h2>7. 日志输出</h2>
        <button onclick="clearLog()">清除日志</button>
        <div id="logContainer" class="log-container">等待日志输出...</div>
    </div>
    
    <div id="errorPopup" class="error-popup" style="display: none;"></div>

    <script>
        // 初始化日志管理器
        const logManager = {
            log: function(level, message, data) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] [${level}] ${message}`;
                console.log(logEntry, data || '');
                
                const logContainer = document.getElementById('logContainer');
                logContainer.textContent += logEntry + '\n';
                if (data) {
                    logContainer.textContent += JSON.stringify(data, null, 2) + '\n';
                }
                logContainer.scrollTop = logContainer.scrollHeight;
            },
            info: function(message, data) { this.log('INFO', message, data); },
            warn: function(message, data) { this.log('WARN', message, data); },
            error: function(message, data) { this.log('ERROR', message, data); }
        };
        
        // 检测平台
        const isAndroid = /Android/i.test(navigator.userAgent);
        logManager.info('平台检测结果', { isAndroid, userAgent: navigator.userAgent });
        
        // 显示错误弹窗
        function showError(message) {
            const errorPopup = document.getElementById('errorPopup');
            errorPopup.textContent = message;
            errorPopup.style.display = 'block';
            
            // 5秒后自动隐藏错误信息
            setTimeout(() => {
                errorPopup.style.display = 'none';
            }, 5000);
        }
        
        // 更新状态显示
        function updateStatus(elementId, message, type = 'info') {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        // 基础HTML5 Audio播放
        let basicAudioRef = null;
        
        function testBasicAudio(audioFile) {
            updateStatus('basicAudioStatus', `正在播放 ${audioFile}...`, 'info');
            logManager.info(`开始测试基础HTML5 Audio播放: ${audioFile}`);
            
            try {
                // 停止之前的播放
                if (basicAudioRef) {
                    basicAudioRef.pause();
                    basicAudioRef.currentTime = 0;
                }
                
                // 创建新的音频元素
                basicAudioRef = new Audio();
                basicAudioRef.src = `./sounds/${audioFile}`;
                
                // 添加事件监听器
                basicAudioRef.addEventListener('canplay', () => {
                    logManager.info(`${audioFile} 可以播放`);
                    basicAudioRef.play().then(() => {
                        updateStatus('basicAudioStatus', `正在播放 ${audioFile}`, 'success');
                        logManager.info(`${audioFile} 播放成功`);
                    }).catch(error => {
                        updateStatus('basicAudioStatus', `播放 ${audioFile} 失败: ${error.message}`, 'error');
                        logManager.error(`${audioFile} 播放失败`, error);
                        showError(`播放 ${audioFile} 失败: ${error.message}`);
                    });
                });
                
                basicAudioRef.addEventListener('error', (e) => {
                    const errorMessage = `${audioFile} 加载失败: ${e.target.error ? e.target.error.message : '未知错误'}`;
                    updateStatus('basicAudioStatus', errorMessage, 'error');
                    logManager.error(errorMessage, e);
                    showError(errorMessage);
                });
                
                basicAudioRef.addEventListener('ended', () => {
                    updateStatus('basicAudioStatus', `${audioFile} 播放结束`, 'info');
                    logManager.info(`${audioFile} 播放结束`);
                });
                
                // 开始加载
                basicAudioRef.load();
            } catch (error) {
                updateStatus('basicAudioStatus', `创建音频元素失败: ${error.message}`, 'error');
                logManager.error('创建音频元素失败', error);
                showError(`创建音频元素失败: ${error.message}`);
            }
        }
        
        function stopBasicAudio() {
            if (basicAudioRef) {
                basicAudioRef.pause();
                basicAudioRef.currentTime = 0;
                updateStatus('basicAudioStatus', '基础Audio已停止', 'info');
                logManager.info('基础HTML5 Audio已停止');
            }
        }
        
        // 临时Audio元素播放
        let tempAudioRefs = [];
        
        function testTempAudio(audioFile) {
            updateStatus('tempAudioStatus', `正在使用临时元素播放 ${audioFile}...`, 'info');
            logManager.info(`开始测试临时Audio元素播放: ${audioFile}`);
            
            try {
                // 创建临时音频元素
                const tempAudio = new Audio();
                tempAudio.src = `./sounds/${audioFile}`;
                tempAudioRefs.push(tempAudio);
                
                // 添加事件监听器
                tempAudio.addEventListener('canplay', () => {
                    logManager.info(`临时 ${audioFile} 可以播放`);
                    tempAudio.play().then(() => {
                        updateStatus('tempAudioStatus', `正在使用临时元素播放 ${audioFile}`, 'success');
                        logManager.info(`临时 ${audioFile} 播放成功`);
                    }).catch(error => {
                        updateStatus('tempAudioStatus', `临时播放 ${audioFile} 失败: ${error.message}`, 'error');
                        logManager.error(`临时 ${audioFile} 播放失败`, error);
                        showError(`临时播放 ${audioFile} 失败: ${error.message}`);
                    });
                });
                
                tempAudio.addEventListener('error', (e) => {
                    const errorMessage = `临时 ${audioFile} 加载失败: ${e.target.error ? e.target.error.message : '未知错误'}`;
                    updateStatus('tempAudioStatus', errorMessage, 'error');
                    logManager.error(errorMessage, e);
                    showError(errorMessage);
                });
                
                tempAudio.addEventListener('ended', () => {
                    updateStatus('tempAudioStatus', `临时 ${audioFile} 播放结束`, 'info');
                    logManager.info(`临时 ${audioFile} 播放结束`);
                });
                
                // 开始加载
                tempAudio.load();
            } catch (error) {
                updateStatus('tempAudioStatus', `创建临时音频元素失败: ${error.message}`, 'error');
                logManager.error('创建临时音频元素失败', error);
                showError(`创建临时音频元素失败: ${error.message}`);
            }
        }
        
        function stopTempAudio() {
            tempAudioRefs.forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            tempAudioRefs = [];
            updateStatus('tempAudioStatus', '临时Audio已停止', 'info');
            logManager.info('临时Audio元素已停止');
        }
        
        // Android原生音频播放
        function testNativeAudio(audioFile) {
            updateStatus('nativeAudioStatus', `正在使用Android原生音频播放 ${audioFile}...`, 'info');
            logManager.info(`开始测试Android原生音频播放: ${audioFile}`);
            
            if (!isAndroid) {
                updateStatus('nativeAudioStatus', '非Android平台，跳过测试', 'warning');
                logManager.warn('非Android平台，跳过Android原生音频测试');
                return;
            }
            
            try {
                // 检查是否有原生音频接口
                if (window.RegularAudioBridge && window.RegularAudioBridge.playRegularAudio) {
                    const success = window.RegularAudioBridge.playRegularAudio(audioFile, 1.0, false);
                    if (success) {
                        updateStatus('nativeAudioStatus', `Android原生音频正在播放 ${audioFile}`, 'success');
                        logManager.info(`Android原生音频播放 ${audioFile} 成功`);
                    } else {
                        updateStatus('nativeAudioStatus', `Android原生音频播放 ${audioFile} 失败`, 'error');
                        logManager.error(`Android原生音频播放 ${audioFile} 失败`);
                        showError(`Android原生音频播放 ${audioFile} 失败`);
                    }
                } else {
                    updateStatus('nativeAudioStatus', 'Android原生音频接口不可用', 'error');
                    logManager.error('Android原生音频接口不可用');
                    showError('Android原生音频接口不可用');
                }
            } catch (error) {
                updateStatus('nativeAudioStatus', `调用Android原生音频接口失败: ${error.message}`, 'error');
                logManager.error('调用Android原生音频接口失败', error);
                showError(`调用Android原生音频接口失败: ${error.message}`);
            }
        }
        
        function stopNativeAudio() {
            if (!isAndroid) {
                updateStatus('nativeAudioStatus', '非Android平台，跳过测试', 'warning');
                return;
            }
            
            try {
                if (window.RegularAudioBridge && window.RegularAudioBridge.stopRegularAudio) {
                    const success = window.RegularAudioBridge.stopRegularAudio();
                    if (success) {
                        updateStatus('nativeAudioStatus', 'Android原生音频已停止', 'success');
                        logManager.info('Android原生音频已停止');
                    } else {
                        updateStatus('nativeAudioStatus', '停止Android原生音频失败', 'error');
                        logManager.error('停止Android原生音频失败');
                        showError('停止Android原生音频失败');
                    }
                } else {
                    updateStatus('nativeAudioStatus', 'Android原生音频接口不可用', 'error');
                    logManager.error('Android原生音频接口不可用');
                    showError('Android原生音频接口不可用');
                }
            } catch (error) {
                updateStatus('nativeAudioStatus', `停止Android原生音频失败: ${error.message}`, 'error');
                logManager.error('停止Android原生音频失败', error);
                showError(`停止Android原生音频失败: ${error.message}`);
            }
        }
        
        // 闹钟播放方法
        function testAlarmAudio(audioFile) {
            updateStatus('alarmAudioStatus', `正在使用闹钟方法播放 ${audioFile}...`, 'info');
            logManager.info(`开始测试闹钟播放方法: ${audioFile}`);
            
            if (!isAndroid) {
                updateStatus('alarmAudioStatus', '非Android平台，跳过测试', 'warning');
                logManager.warn('非Android平台，跳过闹钟播放测试');
                return;
            }
            
            try {
                // 检查是否有闹钟接口
                if (window.AlarmAudioBridge && window.AlarmAudioBridge.playAlarm) {
                    const success = window.AlarmAudioBridge.playAlarm(`./sounds/${audioFile}`, true);
                    if (success) {
                        updateStatus('alarmAudioStatus', `闹钟正在播放 ${audioFile}`, 'success');
                        logManager.info(`闹钟播放 ${audioFile} 成功`);
                    } else {
                        updateStatus('alarmAudioStatus', `闹钟播放 ${audioFile} 失败`, 'error');
                        logManager.error(`闹钟播放 ${audioFile} 失败`);
                        showError(`闹钟播放 ${audioFile} 失败`);
                    }
                } else {
                    updateStatus('alarmAudioStatus', '闹钟接口不可用', 'error');
                    logManager.error('闹钟接口不可用');
                    showError('闹钟接口不可用');
                }
            } catch (error) {
                updateStatus('alarmAudioStatus', `调用闹钟接口失败: ${error.message}`, 'error');
                logManager.error('调用闹钟接口失败', error);
                showError(`调用闹钟接口失败: ${error.message}`);
            }
        }
        
        function stopAlarmAudio() {
            if (!isAndroid) {
                updateStatus('alarmAudioStatus', '非Android平台，跳过测试', 'warning');
                return;
            }
            
            try {
                if (window.AlarmAudioBridge && window.AlarmAudioBridge.stopAlarm) {
                    const success = window.AlarmAudioBridge.stopAlarm();
                    if (success) {
                        updateStatus('alarmAudioStatus', '闹钟已停止', 'success');
                        logManager.info('闹钟已停止');
                    } else {
                        updateStatus('alarmAudioStatus', '停止闹钟失败', 'error');
                        logManager.error('停止闹钟失败');
                        showError('停止闹钟失败');
                    }
                } else {
                    updateStatus('alarmAudioStatus', '闹钟接口不可用', 'error');
                    logManager.error('闹钟接口不可用');
                    showError('闹钟接口不可用');
                }
            } catch (error) {
                updateStatus('alarmAudioStatus', `停止闹钟失败: ${error.message}`, 'error');
                logManager.error('停止闹钟失败', error);
                showError(`停止闹钟失败: ${error.message}`);
            }
        }
        
        // 组合播放测试
        function testCombo1() {
            updateStatus('comboAudioStatus', '正在测试组合1: 1.mp3 + 2.mp3...', 'info');
            logManager.info('开始测试组合1: 1.mp3 + 2.mp3');
            
            // 先播放1.mp3
            testBasicAudio('1.mp3');
            
            // 2秒后播放2.mp3
            setTimeout(() => {
                testTempAudio('2.mp3');
            }, 2000);
        }
        
        function testCombo2() {
            updateStatus('comboAudioStatus', '正在测试组合2: 闹钟 + 震动...', 'info');
            logManager.info('开始测试组合2: 闹钟 + 震动');
            
            // 播放闹钟
            testAlarmAudio('alarm.mp3');
            
            // 触发震动
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
                logManager.info('震动已触发');
            } else {
                logManager.warn('设备不支持震动');
            }
        }
        
        function testCombo3() {
            updateStatus('comboAudioStatus', '正在测试组合3: 1.mp3 + 2.mp3 + 闹钟...', 'info');
            logManager.info('开始测试组合3: 1.mp3 + 2.mp3 + 闹钟');
            
            // 先播放1.mp3
            testBasicAudio('1.mp3');
            
            // 2秒后播放2.mp3
            setTimeout(() => {
                testTempAudio('2.mp3');
            }, 2000);
            
            // 4秒后播放闹钟
            setTimeout(() => {
                testAlarmAudio('alarm.mp3');
            }, 4000);
        }
        
        function stopAllAudio() {
            stopBasicAudio();
            stopTempAudio();
            stopNativeAudio();
            stopAlarmAudio();
            updateStatus('comboAudioStatus', '所有音频已停止', 'info');
            logManager.info('所有音频已停止');
        }
        
        // 错误处理测试
        function testErrorHandling() {
            updateStatus('errorHandlingStatus', '正在测试错误处理...', 'info');
            logManager.info('开始测试错误处理');
            
            try {
                // 尝试播放不存在的文件
                const errorAudio = new Audio();
                errorAudio.src = './sounds/nonexistent.mp3';
                
                errorAudio.addEventListener('error', (e) => {
                    const errorMessage = `错误处理测试: 文件加载失败 - ${e.target.error ? e.target.error.message : '未知错误'}`;
                    updateStatus('errorHandlingStatus', '错误处理测试成功', 'success');
                    logManager.info('错误处理测试成功');
                    showError(errorMessage);
                });
                
                errorAudio.load();
            } catch (error) {
                updateStatus('errorHandlingStatus', `错误处理测试异常: ${error.message}`, 'error');
                logManager.error('错误处理测试异常', error);
                showError(`错误处理测试异常: ${error.message}`);
            }
        }
        
        function testErrorPopup() {
            updateStatus('errorHandlingStatus', '正在测试错误弹窗...', 'info');
            logManager.info('开始测试错误弹窗');
            
            // 显示测试错误弹窗
            showError('这是一个测试错误弹窗，5秒后自动消失');
            updateStatus('errorHandlingStatus', '错误弹窗测试成功', 'success');
            logManager.info('错误弹窗测试成功');
        }
        
        // 清除日志
        function clearLog() {
            document.getElementById('logContainer').textContent = '日志已清除...\n';
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            logManager.info('全面铃声播放测试页面已加载');
            updateStatus('basicAudioStatus', '准备测试基础HTML5 Audio播放', 'info');
            updateStatus('tempAudioStatus', '准备测试临时Audio元素播放', 'info');
            updateStatus('nativeAudioStatus', '准备测试Android原生音频播放', 'info');
            updateStatus('alarmAudioStatus', '准备测试闹钟播放方法', 'info');
            updateStatus('comboAudioStatus', '准备测试组合播放', 'info');
            updateStatus('errorHandlingStatus', '准备测试错误处理', 'info');
        });
    </script>
</body>
</html>