# 睡眠冥想助手 - 打包指南

本文档详细介绍如何构建和打包睡眠冥想助手应用，包括Web资源构建、Android APK生成和签名等步骤。

## 目录

1. [环境准备](#环境准备)
2. [Web资源构建](#web资源构建)
3. [Android APK生成](#android-apk生成)
4. [APK签名](#apk签名)
5. [常见问题解决](#常见问题解决)

## 环境准备

确保已安装以下工具：

- Node.js (v16+)
- npm 或 yarn
- Android Studio (用于Android构建)
- JDK 8+

## Web资源构建

1. **清理npm缓存**
   ```bash
   npm cache clean --force
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **构建Web资源**
   ```bash
   npm run build
   ```

   构建完成后，Web资源会生成在 `dist` 目录中。

## Android APK生成

### 步骤1：同步Capacitor配置

```bash
npx cap sync android
```

此命令会将Web资源复制到Android项目中，并更新配置文件。

### 步骤2：构建Debug版本APK

Debug版本APK已自动签名，可以直接安装到设备：

```bash
cd android
./gradlew assembleDebug
```

生成的APK位置：`android/app/build/outputs/apk/debug/app-debug.apk`

### 步骤3：构建Release版本APK

Release版本APK需要手动签名：

```bash
./gradlew assembleRelease
```

生成的APK位置：`android/app/build/outputs/apk/release/app-release-unsigned.apk`

## APK签名

### 方法1：使用Android Studio签名

1. 打开Android Studio
2. 打开项目的Android目录
3. 选择 `Build` > `Generate Signed Bundle / APK`
4. 按照向导创建或选择密钥库，完成签名过程

### 方法2：使用命令行签名

#### 1. 生成密钥库（如果没有）

```bash
keytool -genkey -v -keystore my-release-key.keystore -alias sleepmelody -keyalg RSA -keysize 2048 -validity 10000
```

#### 2. 签名APK

```bash
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore app-release-unsigned.apk sleepmelody
```

#### 3. 对齐APK

```bash
zipalign -v 4 app-release-unsigned.apk app-release-signed.apk
```

## 常见问题解决

### 问题1：解析软件包时出现问题 33 packageInfo is null

**解决方案**：使用已签名的APK文件，Debug版本已自动签名，可以直接使用。

### 问题2：找不到AlarmReceiver或AlarmService类

**解决方案**：确保AndroidManifest.xml中没有声明不存在的组件。如果不需要这些组件，可以从清单文件中移除。

### 问题3：构建失败，出现依赖错误

**解决方案**：
1. 清理Gradle缓存：`./gradlew cleanBuildCache`
2. 重新同步依赖：`npx cap sync android`
3. 重新构建：`./gradlew assembleDebug`

### 问题4：权限被拒绝

**解决方案**：在应用运行时会自动请求必要的权限，请确保在设备上授予这些权限。

## 构建验证

构建完成后，可以通过以下命令验证APK文件：

```bash
file app-debug.apk
```

输出应该显示：`Zip archive data, at least v0.0 to extract, compression method=deflate`

## 版本控制

每次构建前，建议更新版本号：

1. 在 `android/app/build.gradle` 中更新：
   ```gradle
   versionCode 2       // 递增数字
   versionName "1.1"  // 版本字符串
   ```

2. 在 `package.json` 中更新：
   ```json
   "version": "1.1.0"
   ```

## 注意事项

1. **备份密钥库**：签名用的密钥库文件务必妥善保存，后续更新应用需要使用相同的密钥。

2. **构建缓存**：如果遇到构建问题，尝试清理各种缓存后重新构建。

3. **设备兼容性**：确保目标设备的Android版本不低于应用的 `minSdkVersion`（当前为23）。

4. **文件大小**：APK文件较大（约120MB），包含了所有音频资源，请确保设备有足够的存储空间。

---

按照本指南的步骤，您应该能够成功构建和打包睡眠冥想助手应用。如果遇到任何问题，请参考[常见问题解决](#常见问题解决)部分。